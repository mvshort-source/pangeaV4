<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Pangea</title>
  <meta name="theme-color" content="#0D0D0D"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <meta name="apple-mobile-web-app-title" content="Pangea"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#F7F4EE;-webkit-font-smoothing:antialiased;}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useState, useRef, useEffect, useCallback } = React;

    // ── Config ────────────────────────────────────────────────────────────────
    const SUPABASE_URL = "https://vxgisixavhjiebdgunkd.supabase.co";
    const SUPABASE_KEY = "sb_publishable_4EeToI56Zlso-IW_9LWHcw_BXXWpMKE";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const C = {
      black:"#0D0D0D", offblack:"#1A1A1A", charcoal:"#2E2E2E",
      grey:"#6B6B6B", silver:"#A8A8A0", fog:"#D8D5CE",
      cream:"#F7F4EE", green:"#1B4D35", greenlt:"#2A6B4A",
      navy:"#0D1B2A", white:"#FFFFFF",
    };

    const PANELS = [
      { id:"currents",   label:"Currents",   icon:"〜", color:C.navy    },
      { id:"wharton",    label:"Wharton",    icon:"◈",  color:"#1A5276" },
      { id:"techai",     label:"Tech & AI",  icon:"⬡",  color:C.offblack},
      { id:"money",      label:"Money",      icon:"◆",  color:"#1E5B1E" },
      { id:"creativity", label:"Creativity", icon:"✳",  color:C.green   },
      { id:"soul",       label:"The Soul",   icon:"✦",  color:"#4A3020" },
    ];

    const MOTTO = "I did not know what I thought until I wrote it down.";
    const badgeMap = {pdf:"PDF",slides:"SLIDES",url:"LINK",image:"IMAGE"};

    const SOURCES = [
      { name:"Claude",      desc:"Anthropic's AI",       href:"https://claude.ai"           },
      { name:"ChatGPT",     desc:"OpenAI's AI",          href:"https://chatgpt.com"         },
      { name:"Perplexity",  desc:"AI search",            href:"https://perplexity.ai"       },
      { name:"Wall Street Journal", desc:"Business & markets", href:"https://wsj.com"       },
      { name:"The Ringer",  desc:"Sports & culture",     href:"https://theringer.com"       },
      { name:"Word on Fire",desc:"Bishop Barron",        href:"https://wordonfire.org"      },
    ];

    // ── Helpers ───────────────────────────────────────────────────────────────
    function ts() {
      const d = new Date();
      return {
        date: d.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),
        time: d.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),
      };
    }

    function getPD(id) { return PANELS.find(p => p.id === id); }

    function highlight(text, q) {
      if (!q.trim()) return text;
      const parts = text.split(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"));
      return parts.map((p,i) => i%2===1 ? `<mark>${p}</mark>` : p).join("");
    }

    // ── Supabase DB ───────────────────────────────────────────────────────────
    const DB = {
      async getEntries() {
        const { data, error } = await sb.from("entries").select("*").order("id", { ascending: false });
        if (error) throw error;
        return (data || []).map(r => ({
          id: r.id, date: r.date, time: r.time, type: r.type,
          text: r.text, panels: r.panels || [],
          sourceType: r.source_type, sourceTitle: r.source_title, takeaway: r.takeaway,
        }));
      },
      async addEntry(e) {
        const { error } = await sb.from("entries").insert({
          id: e.id, date: e.date, time: e.time, type: e.type,
          text: e.text, panels: e.panels,
          source_type: e.sourceType || null, source_title: e.sourceTitle || null,
          takeaway: e.takeaway || null,
        });
        if (error) throw error;
      },
      async updateEntry(id, fields) {
        const mapped = {};
        if (fields.text !== undefined)       mapped.text = fields.text;
        if (fields.takeaway !== undefined)   mapped.takeaway = fields.takeaway;
        if (fields.panels !== undefined)     mapped.panels = fields.panels;
        const { error } = await sb.from("entries").update(mapped).eq("id", id);
        if (error) throw error;
      },
      async deleteEntry(id) {
        const { error } = await sb.from("entries").delete().eq("id", id);
        if (error) throw error;
      },
      async getQueue() {
        const { data, error } = await sb.from("queue").select("*").order("id", { ascending: false });
        if (error) throw error;
        return (data || []).map(r => ({
          id: r.id, date: r.date, time: r.time,
          title: r.title, url: r.url, panel: r.panel, done: r.done,
        }));
      },
      async addQueue(q) {
        const { error } = await sb.from("queue").insert({
          id: q.id, date: q.date, time: q.time,
          title: q.title, url: q.url || null, panel: q.panel || null, done: false,
        });
        if (error) throw error;
      },
      async updateQueue(id, fields) {
        const { error } = await sb.from("queue").update(fields).eq("id", id);
        if (error) throw error;
      },
      async deleteQueue(id) {
        const { error } = await sb.from("queue").delete().eq("id", id);
        if (error) throw error;
      },
      async getBooks() {
        const { data, error } = await sb.from("books").select("*").order("id", { ascending: true });
        if (error) throw error;
        return data || [];
      },
      async addBook(b) {
        const { error } = await sb.from("books").insert({ id: b.id, title: b.title, author: b.author || null });
        if (error) throw error;
      },
      async deleteBook(id) {
        const { error } = await sb.from("books").delete().eq("id", id);
        if (error) throw error;
      },
    };

    // ── AI via Netlify proxy ──────────────────────────────────────────────────
    async function analyzeWithClaude(tab, file, urlVal) {
      const panelList = "currents, wharton, techai, money, creativity, soul";
      const messages = [];
      if (tab === "url") {
        messages.push({ role:"user", content:`Analyze this URL and return ONLY a JSON object with: "title" (clean source title), "summary" (3-5 sentence intelligent prose summary), "suggestedPanels" (array of 1-2 panel IDs from: ${panelList}). URL: ${urlVal}` });
      } else {
        const base64 = await new Promise((res,rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result.split(",")[1]);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
        const isImage = file.type.startsWith("image/");
        messages.push({ role:"user", content:[
          isImage
            ? { type:"image", source:{ type:"base64", media_type:file.type, data:base64 } }
            : { type:"document", source:{ type:"base64", media_type:"application/pdf", data:base64 } },
          { type:"text", text:`Analyze this ${isImage?"image":"document"} and return ONLY a JSON object with: "title", "summary" (3-5 sentences), "suggestedPanels" (1-2 IDs from: ${panelList}).` }
        ]});
      }
      const res = await fetch("/.netlify/functions/claude", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ messages }),
      });
      if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e?.error?.message || `Error ${res.status}`); }
      const data = await res.json();
      const text = data.content.map(b=>b.text||"").join("").trim()
        .replace(/^```json\s*/i,"").replace(/^```\s*/i,"").replace(/```\s*$/i,"").trim();
      return JSON.parse(text);
    }

    // ── CSS ───────────────────────────────────────────────────────────────────
    const CSS = "\n@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');\n*{box-sizing:border-box;margin:0;padding:0;}\nbody{background:#F7F4EE;-webkit-font-smoothing:antialiased;}\n\n/* NAV */\n.nav{border-bottom:4px solid #0D0D0D;padding:0 40px;display:flex;align-items:stretch;justify-content:space-between;background:#F7F4EE;position:sticky;top:0;z-index:100;}\n.nav-wm{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;letter-spacing:9px;text-transform:uppercase;padding:14px 24px 14px 0;color:#0D0D0D;cursor:pointer;border-right:4px solid #0D0D0D;display:flex;align-items:center;gap:10px;}\n.nav-arc{flex-shrink:0;}\n.nav-links{display:flex;}\n.nav-link{padding:0 18px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border:none;background:none;border-right:1px solid #D8D5CE;color:#6B6B6B;transition:all .15s;}\n.nav-link:last-child{border-right:none;}\n.nav-link:hover,.nav-link.active{background:#0D0D0D;color:#F7F4EE;}\n.nav-add{color:#1B4D35 !important;border-left:4px solid #1B4D35 !important;font-weight:600 !important;}\n.nav-add:hover{background:#1B4D35 !important;color:#FFFFFF !important;}\n\n/* MASTHEAD */\n.masthead{background:#0D0D0D;padding:10px 40px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #1B4D35;gap:24px;}\n.masthead-l{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#A8A8A0;text-transform:uppercase;white-space:nowrap;}\n.masthead-c{font-family:'Playfair Display',serif;font-size:15px;font-style:italic;color:#F7F4EE;text-align:center;flex:1;}\n.masthead-r{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#1B4D35;text-transform:uppercase;white-space:nowrap;}\n\n/* SEARCH — toned down */\n.search-wrap{border-bottom:1px solid #D8D5CE;padding:0 40px;background:#F7F4EE;display:flex;align-items:center;gap:12px;}\n.search-icon{color:#D8D5CE;font-size:14px;}\n.search-input{flex:1;border:none;background:transparent;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;outline:none;padding:12px 0;color:#6B6B6B;}\n.search-input::placeholder{color:#D8D5CE;}\n.search-count{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;letter-spacing:1px;white-space:nowrap;}\n.search-clear{background:none;border:none;padding:4px 10px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;color:#A8A8A0;transition:color .15s;}\n.search-clear:hover{color:#0D0D0D;}\n.search-results{padding:40px;}\n.sr-hdr{font-family:'Playfair Display',serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;margin-bottom:28px;border-bottom:2px solid #0D0D0D;padding-bottom:14px;}\n.sr-entry{padding:24px 0;border-bottom:1px solid #D8D5CE;cursor:pointer;}\nmark{background:#C8DDD0;padding:0 2px;}\n\n/* HOME HERO — Add left, Reading Now right */\n.home-hero{border-bottom:4px solid #0D0D0D;display:grid;grid-template-columns:1fr 340px;}\n.add-section{padding:36px 40px;border-right:4px solid #0D0D0D;display:flex;flex-direction:column;justify-content:center;gap:16px;}\n.add-section-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#6B6B6B;}\n.add-section-title{font-family:'Playfair Display',serif;font-size:clamp(28px,4vw,42px);font-weight:900;line-height:1.1;color:#0D0D0D;letter-spacing:-1px;}\n.add-section-title em{color:#1B4D35;font-style:normal;}\n.add-btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;}\n.add-btn-primary{background:#0D0D0D;color:#F7F4EE;border:none;padding:14px 28px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:background .15s;display:flex;align-items:center;gap:8px;}\n.add-btn-primary:hover{background:#1B4D35;}\n.add-btn-secondary{background:none;border:2px solid #0D0D0D;color:#0D0D0D;padding:12px 24px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .15s;}\n.add-btn-secondary:hover{background:#0D0D0D;color:#F7F4EE;}\n\n/* READING NOW — compact right column */\n.reading-section{padding:28px 24px;background:#0D0D0D;display:flex;flex-direction:column;}\n.rn-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:16px;display:flex;align-items:center;gap:8px;}\n.rn-label::after{content:'';flex:1;height:1px;background:#2E2E2E;}\n.rn-books{flex:1;display:flex;flex-direction:column;gap:10px;}\n.rn-book{display:flex;align-items:flex-start;gap:10px;padding:12px;background:#1A1A1A;border-left:3px solid var(--bc);}\n.rn-book-info{flex:1;min-width:0;}\n.rn-book-title{font-family:'Playfair Display',serif;font-size:14px;font-weight:700;color:#F7F4EE;line-height:1.3;margin-bottom:2px;}\n.rn-book-author{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#A8A8A0;}\n.rn-book-del{background:none;border:none;cursor:pointer;color:#2E2E2E;font-size:12px;transition:color .15s;flex-shrink:0;padding:2px;}\n.rn-book-del:hover{color:#8B2000;}\n.rn-add-btn{background:none;border:1px dashed #2E2E2E;padding:10px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#6B6B6B;cursor:pointer;transition:all .15s;text-align:left;}\n.rn-add-btn:hover{border-color:#1B4D35;color:#1B4D35;}\n.rn-form{display:flex;flex-direction:column;gap:6px;}\n.rn-inp{background:#1A1A1A;border:1px solid #2E2E2E;padding:8px 10px;font-family:'Playfair Display',serif;font-size:13px;color:#F7F4EE;outline:none;transition:border-color .15s;}\n.rn-inp::placeholder{color:#3A3A3A;}\n.rn-inp:focus{border-color:#1B4D35;}\n.rn-form-btns{display:flex;gap:6px;}\n.rn-save-btn{flex:1;background:#1B4D35;color:#F7F4EE;border:none;padding:8px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;}\n.rn-cancel-btn{background:none;border:1px solid #2E2E2E;color:#6B6B6B;padding:8px 12px;font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;}\n\n/* WRITE BAR */\n.write-bar{background:#1A1A1A;border-bottom:4px solid #1B4D35;padding:0 40px;display:flex;gap:0;align-items:stretch;min-height:56px;}\n.write-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;white-space:nowrap;display:flex;align-items:center;padding-right:20px;border-right:1px solid #2E2E2E;margin-right:20px;}\n.write-input{flex:1;background:transparent;border:none;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:17px;padding:0;outline:none;}\n.write-input::placeholder{color:#555555;}\n.write-sel{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:0 16px;outline:none;cursor:pointer;}\n.write-sel option{background:#1A1A1A;color:#F7F4EE;}\n.post-btn{background:#1B4D35;color:#FFFFFF;border:none;padding:0 22px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:background .15s;border-left:1px solid #2E2E2E;}\n.post-btn:hover{background:#2A6B4A;}\n\n/* MAIN GRID */\n.main-grid{display:grid;grid-template-columns:1fr 340px;}\n.panels-section{border-right:4px solid #0D0D0D;padding:32px 40px;}\n.sec-hdr{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:20px;border-bottom:2px solid #0D0D0D;padding-bottom:10px;}\n.sec-title{font-family:'Playfair Display',serif;font-size:10px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#0D0D0D;}\n.sec-sub{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:1px;}\n\n/* PANEL GRID */\n.panel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;background:#0D0D0D;border:2px solid #0D0D0D;}\n.pc{background:#F7F4EE;padding:20px 16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;border-right:1px solid #D8D5CE;border-bottom:1px solid #D8D5CE;}\n.pc:nth-child(3n){border-right:none;}\n.pc:nth-child(4),.pc:nth-child(5),.pc:nth-child(6){border-bottom:none;}\n.pc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--pc);transform:scaleX(0);transition:transform .25s;transform-origin:left;}\n.pc:hover::after{transform:scaleX(1);}\n.pc:hover{background:#0D0D0D;}\n.pc:hover .pc-icon,.pc:hover .pc-name,.pc:hover .pc-count{color:#F7F4EE;}\n.pc:hover .pc-icon{color:var(--pc);}\n.pc-icon{font-size:15px;margin-bottom:8px;display:block;color:#A8A8A0;transition:color .2s;}\n.pc-name{font-family:'Playfair Display',serif;font-size:13px;font-weight:700;line-height:1.2;margin-bottom:4px;color:#0D0D0D;transition:color .2s;}\n.pc-count{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;transition:color .2s;}\n\n/* JOURNAL SIDEBAR */\n.j-sidebar{padding:32px 24px;}\n.j-feed{display:flex;flex-direction:column;}\n.j-entry{padding:18px 0;border-bottom:1px solid #D8D5CE;}\n.j-meta{display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap;}\n.j-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.j-tag{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;color:#FFFFFF;}\n.j-badge{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;background:#D8D5CE;color:#6B6B6B;}\n.j-src{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;margin-bottom:6px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}\n.j-txt{font-family:'Playfair Display',serif;font-size:14px;line-height:1.65;color:#1A1A1A;}\n.j-takeaway{margin-top:8px;padding-top:8px;border-top:1px solid #D8D5CE;}\n.j-takeaway-lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;display:block;margin-bottom:3px;}\n.j-takeaway-txt{font-family:'Playfair Display',serif;font-size:13px;color:#1B4D35;font-style:italic;line-height:1.55;}\n.j-actions{display:flex;gap:6px;align-items:center;margin-left:auto;}\n.j-edit-btn{background:none;border:none;cursor:pointer;color:#D8D5CE;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;padding:2px 4px;transition:color .15s;}\n.j-edit-btn:hover{color:#0D0D0D;}\n.j-del-btn{background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:12px;padding:2px 4px;transition:color .15s;}\n.j-del-btn:hover{color:#8B2000;}\n.filter-bar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #D8D5CE;}\n.fb{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:4px 8px;border:1px solid #D8D5CE;background:none;cursor:pointer;color:#6B6B6B;transition:all .15s;}\n.fb:hover,.fb.on{background:#0D0D0D;color:#F7F4EE;border-color:#0D0D0D;}\n\n/* EDIT IN PLACE */\n.j-edit-ta{width:100%;border:2px solid #1B4D35;padding:8px 10px;font-family:'Playfair Display',serif;font-size:14px;line-height:1.65;color:#0D0D0D;outline:none;resize:none;background:#FFFFFF;margin-bottom:6px;}\n.j-edit-save{background:#0D0D0D;color:#F7F4EE;border:none;padding:6px 14px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;}\n.j-edit-cancel{background:none;border:1px solid #D8D5CE;color:#6B6B6B;padding:5px 10px;font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;margin-left:6px;}\n\n/* QUEUE PAGE */\n.queue-page{min-height:100vh;}\n.queue-hero{background:#0D0D0D;border-bottom:4px solid #1B4D35;padding:36px 40px;}\n.queue-hero-top{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:24px;}\n.queue-title{font-family:'Playfair Display',serif;font-size:clamp(36px,5vw,64px);font-weight:900;line-height:1;letter-spacing:-2px;color:#FFFFFF;}\n.queue-title em{color:#1B4D35;font-style:normal;}\n.queue-count{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#A8A8A0;}\n.queue-input-wrap{display:flex;background:#1A1A1A;border:2px solid #2E2E2E;}\n.queue-input{flex:1;background:transparent;border:none;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:18px;padding:15px 20px;outline:none;}\n.queue-input::placeholder{color:#3A3A3A;}\n.queue-url-inp{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:10px;padding:0 14px;outline:none;width:180px;}\n.queue-url-inp::placeholder{color:#3A3A3A;}\n.queue-panel-sel{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:9px;padding:0 12px;outline:none;cursor:pointer;}\n.queue-panel-sel option{background:#1A1A1A;color:#F7F4EE;}\n.queue-add-btn{background:#1B4D35;color:#FFFFFF;border:none;padding:0 24px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:background .15s;}\n.queue-add-btn:hover{background:#2A6B4A;}\n.queue-tabs{display:flex;border-bottom:4px solid #0D0D0D;}\n.q-tab{flex:1;padding:13px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;border:none;background:none;cursor:pointer;color:#6B6B6B;border-right:1px solid #D8D5CE;transition:all .15s;}\n.q-tab:last-child{border-right:none;}\n.q-tab.on{background:#0D0D0D;color:#F7F4EE;}\n.q-item{padding:18px 40px;border-bottom:1px solid #D8D5CE;display:flex;align-items:flex-start;gap:14px;transition:background .15s;}\n.q-item:hover{background:#FFFFFF;}\n.q-check{width:20px;height:20px;border:2px solid #D8D5CE;border-radius:50%;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:2px;transition:all .15s;}\n.q-check:hover{border-color:#1B4D35;}\n.q-check.checked{background:#1B4D35;border-color:#1B4D35;color:#FFFFFF;font-size:10px;}\n.q-content{flex:1;min-width:0;}\n.q-title{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;color:#0D0D0D;margin-bottom:3px;line-height:1.3;}\n.q-title.done{text-decoration:line-through;color:#A8A8A0;}\n.q-url{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px;margin-bottom:5px;}\n.q-meta{display:flex;align-items:center;gap:8px;}\n.q-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.q-panel-tag{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;color:#FFFFFF;}\n.q-actions{display:flex;gap:6px;align-items:center;flex-shrink:0;}\n.q-file-btn{background:none;border:1px solid #D8D5CE;padding:5px 10px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;color:#6B6B6B;transition:all .15s;white-space:nowrap;text-decoration:none;display:inline-block;}\n.q-file-btn:hover{border-color:#1B4D35;color:#1B4D35;}\n.q-del{background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:13px;padding:2px 4px;transition:color .15s;}\n.q-del:hover{color:#8B2000;}\n.queue-empty{padding:80px 40px;text-align:center;}\n.queue-empty-txt{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:#A8A8A0;margin-bottom:6px;}\n.queue-empty-sub{font-family:'DM Sans',sans-serif;font-size:13px;color:#A8A8A0;}\n\n/* FILE TO JOURNAL */\n.ftj-overlay{position:fixed;inset:0;background:rgba(13,13,13,.88);z-index:300;display:flex;align-items:center;justify-content:center;padding:24px;}\n.ftj-modal{background:#F7F4EE;width:100%;max-width:520px;border:3px solid #0D0D0D;}\n.ftj-hdr{padding:18px 22px;border-bottom:2px solid #0D0D0D;display:flex;align-items:baseline;justify-content:space-between;}\n.ftj-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:900;}\n.ftj-close{background:none;border:none;font-size:18px;cursor:pointer;color:#6B6B6B;}\n.ftj-body{padding:22px;}\n.ftj-src{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:#A8A8A0;margin-bottom:14px;text-transform:uppercase;}\n.ftj-ta{width:100%;border:2px solid #D8D5CE;padding:12px;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#0D0D0D;outline:none;resize:none;background:#FFFFFF;transition:border-color .15s;}\n.ftj-ta:focus{border-color:#0D0D0D;}\n.ftj-footer{padding:14px 22px;border-top:1px solid #D8D5CE;display:flex;gap:8px;justify-content:flex-end;}\n\n/* PANEL PAGE */\n.panel-page{min-height:100vh;}\n.pp-hero{border-bottom:4px solid #0D0D0D;display:grid;grid-template-columns:8px 1fr auto;}\n.pp-accent{background:var(--dc);}\n.pp-hero-body{padding:44px 40px;}\n.pp-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#6B6B6B;margin-bottom:10px;}\n.pp-title{font-family:'Playfair Display',serif;font-size:clamp(40px,6vw,72px);font-weight:900;line-height:1;letter-spacing:-2px;color:var(--dc);}\n.pp-count{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:12px;}\n.pp-back-col{border-left:4px solid #0D0D0D;display:flex;align-items:flex-start;padding:32px;}\n.pp-back{background:none;border:2px solid #0D0D0D;padding:9px 16px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .15s;color:#0D0D0D;white-space:nowrap;}\n.pp-back:hover{background:#0D0D0D;color:#F7F4EE;}\n.pp-body{padding:36px 40px;}\n.pp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0;background:#0D0D0D;border:2px solid #0D0D0D;}\n.pp-card{background:#F7F4EE;padding:24px;border-right:1px solid #D8D5CE;border-bottom:1px solid #D8D5CE;}\n.pp-card-meta{display:flex;align-items:center;gap:6px;margin-bottom:10px;flex-wrap:wrap;}\n.pp-card-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.pp-card-src{font-family:'DM Mono',monospace;font-size:9px;color:#6B6B6B;margin-bottom:8px;display:block;}\n.pp-card-txt{font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;}\n.pp-card-takeaway{margin-top:12px;padding-top:12px;border-top:1px solid #D8D5CE;}\n.pp-card-tk-lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;display:block;margin-bottom:4px;}\n.pp-card-tk-txt{font-family:'Playfair Display',serif;font-size:14px;line-height:1.65;color:#1B4D35;font-style:italic;}\n.pp-empty{padding:80px 40px;text-align:center;}\n.pp-empty-icon{font-size:40px;margin-bottom:14px;opacity:.15;}\n.pp-empty-txt{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:#A8A8A0;margin-bottom:6px;}\n.pp-empty-sub{font-family:'DM Sans',sans-serif;font-size:13px;color:#A8A8A0;}\n\n/* JOURNAL PAGE */\n.journal-page{min-height:100vh;}\n.journal-hero{border-bottom:4px solid #0D0D0D;padding:40px;display:grid;grid-template-columns:1fr auto;gap:32px;align-items:end;}\n.journal-title{font-family:'Playfair Display',serif;font-size:clamp(40px,5vw,64px);font-weight:900;line-height:1;letter-spacing:-2px;color:#0D0D0D;}\n.journal-title em{color:#1B4D35;font-style:normal;}\n.journal-subtitle{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:8px;}\n.journal-hero-stats{display:flex;gap:24px;align-items:flex-end;}\n.jh-stat{text-align:right;}\n.jh-n{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;line-height:1;color:#0D0D0D;}\n.jh-l{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:2px;}\n.journal-write{background:#1A1A1A;border-bottom:4px solid #1B4D35;padding:20px 40px;}\n.journal-write-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:10px;}\n.journal-textarea{width:100%;background:transparent;border:none;border-bottom:2px solid #2E2E2E;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:18px;line-height:1.6;padding:4px 0 12px;outline:none;resize:none;}\n.journal-textarea::placeholder{color:#555555;}\n.journal-textarea:focus{border-bottom-color:#1B4D35;}\n.journal-write-footer{display:flex;align-items:center;gap:10px;margin-top:10px;}\n.journal-body{display:grid;grid-template-columns:200px 1fr;}\n.journal-filters{border-right:4px solid #0D0D0D;padding:24px 16px;position:sticky;top:0;max-height:100vh;overflow-y:auto;background:#F7F4EE;}\n.jf-section{margin-bottom:22px;}\n.jf-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#6B6B6B;margin-bottom:8px;display:block;}\n.jf-btn{display:block;width:100%;text-align:left;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:6px 8px;border:none;background:none;cursor:pointer;color:#6B6B6B;transition:all .15s;margin-bottom:2px;}\n.jf-btn:hover,.jf-btn.on{background:#0D0D0D;color:#F7F4EE;}\n.journal-feed{padding:0;}\n.day-group{border-bottom:4px solid #0D0D0D;}\n.day-header{padding:14px 40px;background:#0D0D0D;display:flex;align-items:baseline;gap:14px;position:sticky;top:0;z-index:10;}\n.day-date{font-family:'Playfair Display',serif;font-size:18px;font-weight:900;color:#FFFFFF;}\n.day-count{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#A8A8A0;}\n.journal-entry{padding:24px 40px;border-bottom:1px solid #D8D5CE;transition:background .15s;}\n.journal-entry:hover{background:#FFFFFF;}\n.je-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}\n.je-time{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.je-src{font-family:'DM Mono',monospace;font-size:9px;color:#6B6B6B;margin-bottom:8px;display:block;}\n.je-text{font-family:'Playfair Display',serif;font-size:17px;line-height:1.75;color:#1A1A1A;}\n.je-takeaway{margin-top:12px;padding-top:12px;border-top:1px solid #D8D5CE;}\n.je-takeaway-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;margin-bottom:4px;display:block;}\n.je-takeaway-text{font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1B4D35;font-style:italic;}\n.je-actions{display:flex;gap:6px;margin-left:auto;align-items:center;}\n.je-edit{background:none;border:none;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;cursor:pointer;padding:2px 4px;transition:color .15s;}\n.je-edit:hover{color:#0D0D0D;}\n.je-del{background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:12px;padding:2px 4px;transition:color .15s;}\n.je-del:hover{color:#8B2000;}\n\n/* SOURCES */\n.sources{padding:32px 40px;border-top:4px solid #0D0D0D;background:#0D0D0D;}\n.src-label{font-family:'DM Mono',monospace;font-size:9px;font-weight:500;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:20px;display:flex;align-items:center;gap:12px;}\n.src-label::after{content:'';flex:1;height:1px;background:#2E2E2E;}\n.src-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;border:1px solid #2E2E2E;}\n.src-item{padding:18px 20px;border-right:1px solid #2E2E2E;}\n.src-item:nth-child(3n){border-right:none;}\n.src-item:nth-child(n+4){border-top:1px solid #2E2E2E;}\n.src-name{font-family:'Playfair Display',serif;font-weight:700;font-size:14px;margin-bottom:3px;color:#FFFFFF;}\n.src-desc{font-family:'DM Sans',sans-serif;font-size:11px;color:#6B6B6B;margin-bottom:8px;}\n.src-link{font-family:'DM Mono',monospace;font-size:9px;color:#1B4D35;letter-spacing:1px;text-transform:uppercase;text-decoration:none;transition:color .15s;}\n.src-link:hover{color:#F7F4EE;}\n\n/* TOAST */\n.toast{position:fixed;bottom:24px;right:24px;background:#1B4D35;color:#FFFFFF;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:10px 18px;z-index:400;opacity:0;transition:opacity .3s;border-left:3px solid #2A6B4A;pointer-events:none;}\n.toast.show{opacity:1;}\n\n/* ADD/UPLOAD MODAL */\n.overlay{position:fixed;inset:0;background:rgba(13,13,13,.88);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;}\n.modal{background:#F7F4EE;width:100%;max-width:620px;max-height:90vh;overflow-y:auto;border:3px solid #0D0D0D;display:flex;flex-direction:column;}\n.m-hdr{padding:20px 26px 16px;border-bottom:3px solid #0D0D0D;display:flex;align-items:baseline;justify-content:space-between;flex-shrink:0;}\n.m-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:#0D0D0D;}\n.m-close{background:none;border:none;font-size:20px;cursor:pointer;color:#6B6B6B;}\n.m-body{padding:24px 26px;flex:1;}\n.m-footer{padding:16px 26px;border-top:1px solid #D8D5CE;display:flex;gap:10px;justify-content:flex-end;flex-shrink:0;background:#F7F4EE;}\n.m-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-bottom:8px;display:block;}\n.m-sec{margin-bottom:20px;}\n\n/* destination toggle */\n.dest-toggle{display:flex;border:2px solid #0D0D0D;margin-bottom:20px;}\n.dest-btn{flex:1;padding:11px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;border:none;background:none;cursor:pointer;color:#6B6B6B;border-right:1px solid #D8D5CE;transition:all .15s;}\n.dest-btn:last-child{border-right:none;}\n.dest-btn.on{background:#0D0D0D;color:#F7F4EE;}\n\n.tabs{display:flex;border:2px solid #0D0D0D;margin-bottom:18px;}\n.tab{flex:1;padding:10px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;border:none;background:none;cursor:pointer;color:#6B6B6B;border-right:1px solid #D8D5CE;transition:all .15s;}\n.tab:last-child{border-right:none;}\n.tab.on{background:#0D0D0D;color:#F7F4EE;}\n.dz{border:2px dashed #D8D5CE;padding:40px 20px;text-align:center;cursor:pointer;transition:all .2s;background:#FFFFFF;}\n.dz:hover,.dz.drag{border-color:#1B4D35;background:#EDF4F0;}\n.dz-icon{font-size:28px;margin-bottom:8px;}\n.dz-main{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin-bottom:4px;color:#0D0D0D;}\n.dz-sub{font-size:12px;color:#6B6B6B;}\n.url-inp{width:100%;border:2px solid #D8D5CE;padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;background:#FFFFFF;transition:border-color .15s;color:#0D0D0D;}\n.url-inp:focus{border-color:#0D0D0D;}\n.url-note{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;letter-spacing:.5px;margin-top:6px;line-height:1.5;}\n.processing{text-align:center;padding:44px 20px;}\n.spinner{width:36px;height:36px;border:3px solid #D8D5CE;border-top-color:#1B4D35;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;}\n@keyframes spin{to{transform:rotate(360deg);}}\n.proc-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;margin-bottom:6px;color:#0D0D0D;}\n.proc-step{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:#1B4D35;margin-bottom:4px;}\n.ai-banner{background:#EDF4F0;border:1px solid #A8CABB;padding:9px 12px;margin-bottom:18px;display:flex;gap:8px;align-items:center;}\n.ai-banner-txt{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#1B4D35;}\n.sum-box{background:#FFFFFF;border:2px solid #D8D5CE;padding:16px;}\n.sum-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;margin-bottom:8px;display:block;}\n.sum-ta{width:100%;border:none;outline:none;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;resize:none;background:transparent;}\n.title-inp{width:100%;border:2px solid #D8D5CE;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;background:#FFFFFF;transition:border-color .15s;color:#0D0D0D;}\n.title-inp:focus{border-color:#0D0D0D;}\n.panel-picker{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}\n.ppc{border:2px solid #D8D5CE;padding:9px 7px;cursor:pointer;transition:all .15s;text-align:center;background:#FFFFFF;position:relative;}\n.ppc:hover{border-color:#A8A8A0;}\n.ppc.on{border-color:var(--ppc);background:var(--ppc);}\n.ppc.on .ppc-icon,.ppc.on .ppc-lbl{color:#FFFFFF;}\n.ppc-icon{font-size:14px;display:block;margin-bottom:3px;transition:color .15s;color:#6B6B6B;}\n.ppc-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;text-transform:uppercase;color:#6B6B6B;line-height:1.2;transition:color .15s;}\n.ppc-check{position:absolute;top:3px;right:3px;font-size:9px;color:#FFFFFF;font-weight:900;}\n.ai-sug{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:.5px;margin-top:7px;}\n.ai-sug span{color:#1B4D35;}\n.btn-ghost{background:none;border:2px solid #D8D5CE;padding:9px 18px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;color:#6B6B6B;transition:all .15s;}\n.btn-ghost:hover{border-color:#0D0D0D;color:#0D0D0D;}\n.btn-solid{background:#0D0D0D;color:#FFFFFF;border:none;padding:9px 22px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:background .15s;}\n.btn-solid:hover{background:#1B4D35;}\n.btn-solid:disabled{opacity:.35;pointer-events:none;}\n.err-box{background:#FDF0EE;border:1px solid #E8B4A8;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:13px;color:#8B2000;margin-bottom:14px;}\n.takeaway-inp{width:100%;border:2px solid #D8D5CE;padding:12px 14px;background:#FFFFFF;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;resize:none;outline:none;transition:border-color .2s;display:block;}\n.takeaway-inp:focus{border-color:#0D0D0D;}\n.takeaway-inp.nudge{border-color:#1B4D35;}\n.nudge-msg{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#1B4D35;text-transform:uppercase;margin-top:5px;}\n\n/* LOADING */\n.loading{display:flex;align-items:center;justify-content:center;height:100vh;font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;color:#6B6B6B;background:#F7F4EE;text-transform:uppercase;}\n\n@media(max-width:768px){\n  .nav{padding:0 16px;}\n  .nav-wm{font-size:16px;letter-spacing:6px;padding-right:14px;}\n  .nav-link{padding:0 10px;font-size:9px;}\n  .masthead{padding:8px 16px;}\n  .masthead-c{font-size:12px;}\n  .home-hero{grid-template-columns:1fr;}\n  .reading-section{border-top:4px solid #0D0D0D;}\n  .add-section{padding:24px 16px;}\n  .write-bar{padding:0 12px;}\n  .main-grid{grid-template-columns:1fr;}\n  .panels-section{border-right:none;border-bottom:4px solid #0D0D0D;padding:20px 16px;}\n  .j-sidebar{padding:20px 16px;}\n  .queue-hero{padding:20px 16px;}\n  .queue-input-wrap{flex-direction:column;}\n  .queue-url-inp{width:100%;border-left:none;border-top:1px solid #2E2E2E;padding:12px 16px;}\n  .queue-panel-sel{border-left:none;border-top:1px solid #2E2E2E;padding:12px 16px;}\n  .queue-add-btn{padding:14px;width:100%;}\n  .q-item{padding:14px 16px;}\n  .journal-body{grid-template-columns:1fr;}\n  .journal-filters{display:none;}\n  .journal-entry{padding:18px 16px;}\n  .day-header{padding:12px 16px;}\n  .pp-hero{grid-template-columns:6px 1fr;}\n  .pp-back-col{display:none;}\n  .pp-body{padding:18px 16px;}\n  .sources{padding:20px 16px;}\n  .src-grid{grid-template-columns:1fr 1fr;}\n  .src-item:nth-child(2n){border-right:none;}\n  .src-item:nth-child(3n){border-right:1px solid #2E2E2E;}\n}\n    ";

    // ── Arc Logo SVG ──────────────────────────────────────────────────────────
    function ArcMark({ size = 32, color = "#0D0D0D", accentColor = "#1B4D35" }) {
      return (
        <svg width={size} height={size} viewBox="0 0 44 44" fill="none" className="nav-arc">
          <path d="M 38 22 A 16 16 0 1 1 33 9"
                stroke={color} strokeWidth="5" strokeLinecap="round" fill="none"/>
          <path d="M 33 9 L 38 14"
                stroke={accentColor} strokeWidth="3" strokeLinecap="round"/>
        </svg>
      );
    }

    // ── Main App ──────────────────────────────────────────────────────────────
    function Pangea() {
      const [entries,  setEntries]  = useState([]);
      const [queue,    setQueue]    = useState([]);
      const [books,    setBooks]    = useState([]);
      const [loaded,   setLoaded]   = useState(false);
      const [dbErr,    setDbErr]    = useState(null);
      const [view,     setView]     = useState("home");
      const [activePanelId, setActivePanelId] = useState(null);

      // Home
      const [writeText,  setWriteText]  = useState("");
      const [writePanel, setWritePanel] = useState("");
      const [filterPanel, setFilterPanel] = useState(null);

      // Reading Now
      const [addingBook,  setAddingBook]  = useState(false);
      const [bookTitle,   setBookTitle]   = useState("");
      const [bookAuthor,  setBookAuthor]  = useState("");

      // Journal
      const [jFilter,     setJFilter]     = useState("all");
      const [jPanel,      setJPanel]      = useState(null);
      const [jWriting,    setJWriting]    = useState("");
      const [jWritePanel, setJWritePanel] = useState("");
      const [editingId,   setEditingId]   = useState(null);
      const [editText,    setEditText]    = useState("");

      // Queue
      const [qInput,  setQInput]  = useState("");
      const [qUrl,    setQUrl]    = useState("");
      const [qPanel,  setQPanel]  = useState("");
      const [qTab,    setQTab]    = useState("pending");
      const [ftjItem, setFtjItem] = useState(null);
      const [ftjNote, setFtjNote] = useState("");
      const [ftjPanel,setFtjPanel]= useState("");

      // Search
      const [searchQ, setSearchQ] = useState("");

      // Modal
      const [showModal,   setShowModal]   = useState(false);
      const [modalDest,   setModalDest]   = useState("panel"); // panel | queue
      const [tab,         setTab]         = useState("file");
      const [stage,       setStage]       = useState("input");
      const [procStep,    setProcStep]    = useState("");
      const [dragOver,    setDragOver]    = useState(false);
      const [chosenFile,  setChosenFile]  = useState(null);
      const [urlVal,      setUrlVal]      = useState("");
      const [editSum,     setEditSum]     = useState("");
      const [editTitle,   setEditTitle]   = useState("");
      const [editPanels,  setEditPanels]  = useState([]);
      const [aiPanels,    setAiPanels]    = useState([]);
      const [editTakeaway,setEditTakeaway]= useState("");
      const [nudgeTakeaway,setNudgeTakeaway] = useState(false);
      const [aiType,      setAiType]      = useState("");
      const [apiError,    setApiError]    = useState("");

      const [showToast, setShowToast] = useState(false);
      const fileRef = useRef();

      // ── Load from Supabase ─────────────────────────────────────────────────
      useEffect(() => {
        async function load() {
          try {
            const [e, q, b] = await Promise.all([DB.getEntries(), DB.getQueue(), DB.getBooks()]);
            setEntries(e); setQueue(q); setBooks(b);
          } catch(err) {
            console.error("DB load error:", err);
            setDbErr(err.message);
          }
          setLoaded(true);
        }
        load();
      }, []);

      const toast = () => { setShowToast(true); setTimeout(() => setShowToast(false), 1600); };
      const today = new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}).toUpperCase();

      // This week count
      const MONTHS = {JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11};
      const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate()-7);
      const thisWeek = entries.filter(e => {
        try { const[m,d]=e.date.split(" "); return new Date(new Date().getFullYear(),MONTHS[m]??0,parseInt(d))>=oneWeekAgo; }
        catch { return false; }
      }).length;

      // ── Entry CRUD ─────────────────────────────────────────────────────────
      const addEntry = async (e) => {
        await DB.addEntry(e);
        setEntries(prev => [e, ...prev]);
        toast();
      };
      const delEntry = async (id) => {
        await DB.deleteEntry(id);
        setEntries(prev => prev.filter(e => e.id !== id));
        toast();
      };
      const saveEdit = async (id) => {
        await DB.updateEntry(id, { text: editText });
        setEntries(prev => prev.map(e => e.id === id ? {...e, text: editText} : e));
        setEditingId(null); setEditText("");
        toast();
      };

      // ── Queue CRUD ─────────────────────────────────────────────────────────
      const addQueueItem = async () => {
        if (!qInput.trim()) return;
        const item = { id:Date.now(), ...ts(), title:qInput.trim(), url:qUrl.trim(), panel:qPanel, done:false };
        await DB.addQueue(item);
        setQueue(prev => [item, ...prev]);
        setQInput(""); setQUrl(""); setQPanel("");
        toast();
      };
      const delQueue = async (id) => {
        await DB.deleteQueue(id);
        setQueue(prev => prev.filter(q => q.id !== id));
      };
      const toggleDone = async (id) => {
        const item = queue.find(q => q.id === id);
        const next = !item.done;
        await DB.updateQueue(id, { done: next });
        setQueue(prev => prev.map(q => q.id === id ? {...q, done: next} : q));
      };

      // ── Books CRUD ─────────────────────────────────────────────────────────
      const addBook = async () => {
        if (!bookTitle.trim()) return;
        const b = { id:Date.now(), title:bookTitle.trim(), author:bookAuthor.trim() };
        await DB.addBook(b);
        setBooks(prev => [...prev, b]);
        setBookTitle(""); setBookAuthor(""); setAddingBook(false);
        toast();
      };
      const delBook = async (id) => {
        await DB.deleteBook(id);
        setBooks(prev => prev.filter(b => b.id !== id));
      };

      // ── Modal ──────────────────────────────────────────────────────────────
      const closeModal = () => {
        setShowModal(false); setStage("input"); setChosenFile(null); setUrlVal("");
        setEditSum(""); setEditTitle(""); setEditPanels([]); setAiPanels([]);
        setEditTakeaway(""); setNudgeTakeaway(false); setAiType(""); setApiError(""); setProcStep("");
      };
      const togglePP = (id) => setEditPanels(p => p.includes(id) ? p.filter(x=>x!==id) : [...p,id]);
      const getType = () => { if(tab==="url")return"url"; if(tab==="image")return"image"; if(!chosenFile)return"pdf"; return chosenFile.name.toLowerCase().includes("slide")||chosenFile.name.toLowerCase().includes("lecture")?"slides":"pdf"; };

      const analyze = async () => {
        const type = getType(); setAiType(type); setStage("processing"); setApiError("");
        try {
          setProcStep("Reading content…"); await new Promise(r=>setTimeout(r,300));
          setProcStep("Extracting key ideas…");
          const result = await analyzeWithClaude(tab, chosenFile, urlVal);
          setEditTitle(result.title || chosenFile?.name || urlVal);
          setEditSum(result.summary || "");
          const sug = Array.isArray(result.suggestedPanels)?result.suggestedPanels:(result.suggestedPanel?[result.suggestedPanel]:[]);
          setAiPanels(sug); setEditPanels(sug); setStage("review");
        } catch(err) { setApiError(err.message||"Something went wrong."); setStage("input"); }
      };

      const saveUpload = async () => {
        if (!editTakeaway.trim()) { setNudgeTakeaway(true); return; }
        const e = {id:Date.now(),...ts(),panels:editPanels,type:"upload",sourceType:aiType,sourceTitle:editTitle,text:editSum.trim(),takeaway:editTakeaway.trim()};
        await addEntry(e); closeModal();
      };
      const saveUploadAnyway = async () => {
        const e = {id:Date.now(),...ts(),panels:editPanels,type:"upload",sourceType:aiType,sourceTitle:editTitle,text:editSum.trim(),takeaway:""};
        await addEntry(e); closeModal();
      };

      const postNote = async (text, panel, cb) => {
        if (!text.trim()) return;
        await addEntry({id:Date.now(),...ts(),panels:panel?[panel]:[],type:"note",text:text.trim()});
        cb();
      };

      // Add to queue from modal
      const saveToQueue = async () => {
        if (!editTitle.trim()) return;
        const item = {id:Date.now(),...ts(),title:editTitle.trim(),url:urlVal.trim(),panel:editPanels[0]||"",done:false};
        await DB.addQueue(item);
        setQueue(prev => [item, ...prev]);
        toast(); closeModal();
      };

      // ── Search ─────────────────────────────────────────────────────────────
      const searchResults = searchQ.trim().length > 1
        ? entries.filter(e => { const q=searchQ.toLowerCase(); return e.text.toLowerCase().includes(q)||(e.sourceTitle||"").toLowerCase().includes(q)||(e.panels||[]).some(pid=>(getPD(pid)?.label||"").toLowerCase().includes(q)); })
        : [];

      // ── Shared components ──────────────────────────────────────────────────
      function Nav({ current }) {
        return (
          <nav className="nav">
            <div className="nav-wm" onClick={()=>{ setView("home"); setActivePanelId(null); }}>
              <ArcMark size={28} color="#0D0D0D" accentColor="#1B4D35" />
              PAN<span style={{color:"#1B4D35"}}>G</span>EA
            </div>
            <div className="nav-links">
              <button className={`nav-link ${current==="home"?"active":""}`}    onClick={()=>{ setView("home"); setActivePanelId(null); }}>Home</button>
              <button className={`nav-link ${current==="queue"?"active":""}`}   onClick={()=>setView("queue")}>Queue</button>
              <button className={`nav-link ${current==="journal"?"active":""}`} onClick={()=>setView("journal")}>Journal</button>
              <button className="nav-link nav-add" onClick={()=>setShowModal(true)}>+ Add</button>
            </div>
          </nav>
        );
      }

      function Masthead({ right }) {
        return (
          <div className="masthead">
            <span className="masthead-l">{today}</span>
            <span className="masthead-c">&#8220;{MOTTO}&#8221;</span>
            <span className="masthead-r">{right}</span>
          </div>
        );
      }

      // ── Add Modal ──────────────────────────────────────────────────────────
      function renderModal() {
        return (
          <div className="overlay" onClick={e=>e.target===e.currentTarget&&closeModal()}>
            <div className="modal">
              <div className="m-hdr">
                <span className="m-title">{stage==="input"?"Add to Pangea":stage==="processing"?"Analyzing…":"Review & File"}</span>
                <button className="m-close" onClick={closeModal}>✕</button>
              </div>

              {stage==="input"&&<>
                <div className="m-body">
                  {apiError&&<div className="err-box">⚠ {apiError}</div>}
                  {/* Destination */}
                  <div className="dest-toggle">
                    <button className={`dest-btn ${modalDest==="panel"?"on":""}`} onClick={()=>setModalDest("panel")}>→ Panel + Journal</button>
                    <button className={`dest-btn ${modalDest==="queue"?"on":""}`} onClick={()=>setModalDest("queue")}>→ My Queue</button>
                  </div>
                  {modalDest==="queue" ? (
                    <div className="m-sec">
                      <span className="m-label">Title or note</span>
                      <input className="title-inp" style={{marginBottom:10}} placeholder="What do you want to read or look up?" value={editTitle} onChange={e=>setEditTitle(e.target.value)} />
                      <span className="m-label">URL (optional)</span>
                      <input className="url-inp" placeholder="https://…" value={urlVal} onChange={e=>setUrlVal(e.target.value)} />
                      <div style={{marginTop:12}}>
                        <span className="m-label">Panel (optional)</span>
                        <div className="panel-picker">
                          {PANELS.map(p=>{ const on=editPanels.includes(p.id); return(
                            <div key={p.id} className={`ppc ${on?"on":""}`} style={{"--ppc":p.color}} onClick={()=>togglePP(p.id)}>
                              <span className="ppc-icon">{p.icon}</span>
                              <span className="ppc-lbl">{p.label}</span>
                              {on&&<span className="ppc-check">✓</span>}
                            </div>
                          );})}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="tabs">
                        {[["file","📄 PDF / Slides"],["image","📸 Image"],["url","🔗 URL"]].map(([id,lbl])=>(
                          <button key={id} className={`tab ${tab===id?"on":""}`} onClick={()=>{setTab(id);setChosenFile(null);setUrlVal("");}}>{lbl}</button>
                        ))}
                      </div>
                      {(tab==="file"||tab==="image")&&(
                        <div className={`dz ${dragOver?"drag":""}`}
                          onClick={()=>fileRef.current?.click()}
                          onDragOver={e=>{e.preventDefault();setDragOver(true);}}
                          onDragLeave={()=>setDragOver(false)}
                          onDrop={e=>{e.preventDefault();setDragOver(false);setChosenFile(e.dataTransfer.files[0]);}}>
                          <div className="dz-icon">{tab==="image"?"📸":"📄"}</div>
                          <div className="dz-main">{chosenFile?chosenFile.name:tab==="image"?"Drop an image":"Drop a PDF here"}</div>
                          <div className="dz-sub">{chosenFile?"Ready — click Analyze":"or click to browse"}</div>
                          <input ref={fileRef} type="file" accept={tab==="image"?"image/*":".pdf"} style={{display:"none"}} onChange={e=>setChosenFile(e.target.files[0])} />
                        </div>
                      )}
                      {tab==="url"&&(
                        <div className="m-sec">
                          <span className="m-label">Paste a URL</span>
                          <input className="url-inp" placeholder="https://…" value={urlVal} onChange={e=>setUrlVal(e.target.value)} onKeyDown={e=>e.key==="Enter"&&urlVal.trim()&&analyze()} />
                          <div className="url-note">AI will attempt to summarize based on the URL. For best results, paste article text directly.</div>
                        </div>
                      )}
                    </>
                  )}
                </div>
                <div className="m-footer">
                  <button className="btn-ghost" onClick={closeModal}>Cancel</button>
                  {modalDest==="queue"
                    ? <button className="btn-solid" onClick={saveToQueue} disabled={!editTitle.trim()}>Add to Queue →</button>
                    : <button className="btn-solid" onClick={analyze} disabled={!((tab==="file"&&chosenFile)||(tab==="image"&&chosenFile)||(tab==="url"&&urlVal.trim()))}>Analyze →</button>
                  }
                </div>
              </>}

              {stage==="processing"&&(
                <div className="m-body">
                  <div className="processing">
                    <div className="spinner"></div>
                    <div className="proc-step">{procStep}</div>
                    <div className="proc-title">Claude is reading your content</div>
                  </div>
                </div>
              )}

              {stage==="review"&&<>
                <div className="m-body">
                  <div className="ai-banner"><span>✦</span><span className="ai-banner-txt">AI summary — edit freely</span></div>
                  <div className="m-sec">
                    <span className="m-label">Source title</span>
                    <input className="title-inp" value={editTitle} onChange={e=>setEditTitle(e.target.value)} placeholder="What is this from?" />
                  </div>
                  <div className="m-sec">
                    <span className="m-label">Summary</span>
                    <div className="sum-box">
                      <span className="sum-lbl">✦ AI Draft</span>
                      <textarea className="sum-ta" value={editSum} onChange={e=>setEditSum(e.target.value)} rows={5} />
                    </div>
                  </div>
                  <div className="m-sec">
                    <span className="m-label">File to panels</span>
                    <div className="panel-picker">
                      {PANELS.map(p=>{ const on=editPanels.includes(p.id); return(
                        <div key={p.id} className={`ppc ${on?"on":""}`} style={{"--ppc":p.color}} onClick={()=>togglePP(p.id)}>
                          <span className="ppc-icon">{p.icon}</span>
                          <span className="ppc-lbl">{p.label}</span>
                          {on&&<span className="ppc-check">✓</span>}
                        </div>
                      );})}
                    </div>
                    {aiPanels.length>0&&(
                      <div className="ai-sug">AI suggested: <span>{aiPanels.map(id=>getPD(id)).filter(Boolean).map(p=>`${p.icon} ${p.label}`).join(", ")}</span>
                        {JSON.stringify([...aiPanels].sort())!==JSON.stringify([...editPanels].sort())&&
                          <button onClick={()=>setEditPanels(aiPanels)} style={{marginLeft:8,fontFamily:"DM Mono,monospace",fontSize:9,background:"none",border:"none",color:"#1B4D35",cursor:"pointer",textTransform:"uppercase",letterSpacing:1}}>Use →</button>
                        }
                      </div>
                    )}
                  </div>
                  <div className="m-sec">
                    <span className="m-label">Your takeaway <span style={{color:"#A8A8A0",letterSpacing:0,textTransform:"none",fontSize:10}}>— optional but encouraged</span></span>
                    <textarea className={`takeaway-inp ${nudgeTakeaway?"nudge":""}`} placeholder="What's your takeaway?" value={editTakeaway} onChange={e=>{setEditTakeaway(e.target.value);setNudgeTakeaway(false);}} rows={3} />
                    {nudgeTakeaway&&<div className="nudge-msg">✦ Take a moment — what did this mean to you?</div>}
                  </div>
                </div>
                <div className="m-footer">
                  <button className="btn-ghost" onClick={()=>{setStage("input");setApiError("");}}>← Back</button>
                  {nudgeTakeaway&&<button className="btn-ghost" onClick={saveUploadAnyway} style={{fontSize:9}}>Skip →</button>}
                  <button className="btn-solid" onClick={saveUpload}>Save to Pangea →</button>
                </div>
              </>}
            </div>
          </div>
        );
      }

      if (!loaded) return <div className="loading">Loading Pangea…</div>;
      if (dbErr)   return <div className="loading" style={{flexDirection:"column",gap:12}}>
        <div>Database error</div>
        <div style={{fontSize:10,color:"#A8A8A0",maxWidth:400,textAlign:"center"}}>{dbErr}</div>
      </div>;

      // ── PANEL PAGE ──────────────────────────────────────────────────────────
      if (view==="panel"&&activePanelId) {
        const p = getPD(activePanelId);
        const panelEntries = entries.filter(e=>(e.panels||[]).includes(activePanelId));
        return (
          <div style={{fontFamily:"DM Sans,sans-serif",color:C.black,background:C.cream,minHeight:"100vh"}}>
            <style>{CSS}</style>
            <div className={`toast ${showToast?"show":""}`}>✓ Saved</div>
            {showModal&&renderModal()}
            <Nav current="" />
            <Masthead right={p.label} />
            <div className="pp-hero" style={{"--dc":p.color}}>
              <div className="pp-accent"></div>
              <div className="pp-hero-body">
                <div className="pp-label">Panel</div>
                <div className="pp-title">{p.label}</div>
                <div className="pp-count">{panelEntries.length} {panelEntries.length===1?"entry":"entries"}</div>
              </div>
              <div className="pp-back-col">
                <button className="pp-back" onClick={()=>{ setView("home"); setActivePanelId(null); }}>← Back</button>
              </div>
            </div>
            {panelEntries.length===0 ? (
              <div className="pp-empty">
                <div className="pp-empty-icon">{p.icon}</div>
                <div className="pp-empty-txt">Nothing filed here yet</div>
                <div className="pp-empty-sub">Add a note or upload something tagged to {p.label}</div>
              </div>
            ) : (
              <div className="pp-body">
                <div className="pp-grid">
                  {panelEntries.map(entry=>{
                    const others=(entry.panels||[]).filter(pid=>pid!==activePanelId).map(pid=>getPD(pid)).filter(Boolean);
                    return (
                      <div key={entry.id} className="pp-card">
                        <div className="pp-card-meta">
                          <span className="pp-card-date">{entry.date} · {entry.time}</span>
                          {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                          {others.map(op=><span key={op.id} className="j-tag" style={{background:op.color}}>{op.label}</span>)}
                        </div>
                        {entry.sourceTitle&&<span className="pp-card-src">↳ {entry.sourceTitle}</span>}
                        <div className="pp-card-txt">{entry.text}</div>
                        {entry.takeaway&&(
                          <div className="pp-card-takeaway">
                            <span className="pp-card-tk-lbl">Your takeaway</span>
                            <div className="pp-card-tk-txt">{entry.takeaway}</div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        );
      }

      // ── QUEUE PAGE ──────────────────────────────────────────────────────────
      if (view==="queue") {
        const pending   = queue.filter(q=>!q.done);
        const completed = queue.filter(q=>q.done);
        const displayed = qTab==="pending" ? pending : completed;

        const fileToJournal = (item) => { setFtjItem(item); setFtjNote(item.title); setFtjPanel(item.panel||""); };
        const saveFtj = async () => {
          if (!ftjNote.trim()) return;
          await addEntry({id:Date.now(),...ts(),panels:ftjPanel?[ftjPanel]:[],type:"note",text:ftjNote.trim()});
          await toggleDone(ftjItem.id);
          setFtjItem(null); setFtjNote(""); setFtjPanel("");
        };

        return (
          <div style={{fontFamily:"DM Sans,sans-serif",color:C.black,background:C.cream,minHeight:"100vh"}}>
            <style>{CSS}</style>
            <div className={`toast ${showToast?"show":""}`}>✓ Saved</div>
            {showModal&&renderModal()}
            {ftjItem&&(
              <div className="ftj-overlay" onClick={e=>e.target===e.currentTarget&&setFtjItem(null)}>
                <div className="ftj-modal">
                  <div className="ftj-hdr">
                    <span className="ftj-title">File to Journal</span>
                    <button className="ftj-close" onClick={()=>setFtjItem(null)}>✕</button>
                  </div>
                  <div className="ftj-body">
                    <div className="ftj-src">From queue: {ftjItem.title}</div>
                    <span className="m-label" style={{marginBottom:8,display:"block"}}>Your note</span>
                    <textarea className="ftj-ta" value={ftjNote} onChange={e=>setFtjNote(e.target.value)} rows={5} placeholder="What did you take from this?" />
                    <div style={{marginTop:14}}>
                      <span className="m-label" style={{marginBottom:8,display:"block"}}>Panel</span>
                      <select style={{width:"100%",border:"2px solid #D8D5CE",padding:"8px 10px",fontFamily:"DM Mono,monospace",fontSize:10,color:"#0D0D0D",background:"#FFFFFF",outline:"none"}} value={ftjPanel} onChange={e=>setFtjPanel(e.target.value)}>
                        <option value="">No panel</option>
                        {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                      </select>
                    </div>
                  </div>
                  <div className="ftj-footer">
                    <button className="btn-ghost" onClick={()=>setFtjItem(null)}>Cancel</button>
                    <button className="btn-solid" onClick={saveFtj}>Save to Journal →</button>
                  </div>
                </div>
              </div>
            )}
            <Nav current="queue" />
            <Masthead right="Queue" />
            <div className="queue-hero">
              <div className="queue-hero-top">
                <div className="queue-title">My <em>Queue</em></div>
                <div className="queue-count">{pending.length} pending · {completed.length} done</div>
              </div>
              <div className="queue-input-wrap">
                <input className="queue-input" placeholder="What do you want to read or look up?" value={qInput} onChange={e=>setQInput(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addQueueItem()} />
                <input className="queue-url-inp" placeholder="URL (optional)" value={qUrl} onChange={e=>setQUrl(e.target.value)} />
                <select className="queue-panel-sel" value={qPanel} onChange={e=>setQPanel(e.target.value)}>
                  <option value="">Panel…</option>
                  {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                </select>
                <button className="queue-add-btn" onClick={addQueueItem}>Add →</button>
              </div>
            </div>
            <div className="queue-tabs">
              <button className={`q-tab ${qTab==="pending"?"on":""}`} onClick={()=>setQTab("pending")}>Pending ({pending.length})</button>
              <button className={`q-tab ${qTab==="done"?"on":""}`}    onClick={()=>setQTab("done")}>Done ({completed.length})</button>
            </div>
            <div className="queue-list">
              {displayed.length===0 ? (
                <div className="queue-empty">
                  <div className="queue-empty-txt">{qTab==="pending"?"Queue is clear":"Nothing done yet"}</div>
                  <div className="queue-empty-sub">{qTab==="pending"?"Add something above":"Complete items will appear here"}</div>
                </div>
              ) : displayed.map(item=>{
                const pd = item.panel ? getPD(item.panel) : null;
                return (
                  <div key={item.id} className={`q-item ${item.done?"done":""}`}>
                    <div className={`q-check ${item.done?"checked":""}`} onClick={()=>toggleDone(item.id)}>{item.done&&"✓"}</div>
                    <div className="q-content">
                      <div className={`q-title ${item.done?"done":""}`}>{item.title}</div>
                      {item.url&&<div className="q-url">{item.url}</div>}
                      <div className="q-meta">
                        <span className="q-date">{item.date}</span>
                        {pd&&<span className="q-panel-tag" style={{background:pd.color}}>{pd.label}</span>}
                      </div>
                    </div>
                    <div className="q-actions">
                      {item.done&&<button className="q-file-btn" onClick={()=>fileToJournal(item)}>→ Journal</button>}
                      {!item.done&&item.url&&<a href={item.url} target="_blank" rel="noreferrer" className="q-file-btn">Open →</a>}
                      {!item.done&&<button className="q-file-btn" onClick={()=>toggleDone(item.id)}>Done ✓</button>}
                      <button className="q-del" onClick={()=>delQueue(item.id)}>✕</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // ── JOURNAL PAGE ────────────────────────────────────────────────────────
      if (view==="journal") {
        let jEntries = [...entries];
        if (jFilter==="notes")   jEntries = jEntries.filter(e=>e.type==="note");
        if (jFilter==="uploads") jEntries = jEntries.filter(e=>e.type==="upload");
        if (jPanel) jEntries = jEntries.filter(e=>(e.panels||[]).includes(jPanel));

        const groups = [];
        const seen = {};
        jEntries.forEach(e => {
          if (!seen[e.date]) { seen[e.date]=[]; groups.push({date:e.date,entries:seen[e.date]}); }
          seen[e.date].push(e);
        });

        return (
          <div style={{fontFamily:"DM Sans,sans-serif",color:C.black,background:C.cream,minHeight:"100vh"}}>
            <style>{CSS}</style>
            <div className={`toast ${showToast?"show":""}`}>✓ Saved</div>
            {showModal&&renderModal()}
            <Nav current="journal" />
            <Masthead right="Journal" />
            <div className="journal-hero">
              <div>
                <div className="journal-title">Your <em>Journal</em></div>
                <div className="journal-subtitle">{entries.length} {entries.length===1?"entry":"entries"} · {thisWeek} this week</div>
              </div>
              <div className="journal-hero-stats">
                <div className="jh-stat"><div className="jh-n">{entries.filter(e=>e.type==="note").length}</div><div className="jh-l">Notes</div></div>
                <div className="jh-stat"><div className="jh-n">{entries.filter(e=>e.type==="upload").length}</div><div className="jh-l">Uploads</div></div>
              </div>
            </div>
            <div className="journal-write">
              <div className="journal-write-label">Write</div>
              <textarea className="journal-textarea" placeholder="What's on your mind?" value={jWriting} rows={3}
                onChange={e=>setJWriting(e.target.value)}
                onKeyDown={e=>{ if(e.key==="Enter"&&(e.metaKey||e.ctrlKey)) postNote(jWriting,jWritePanel,()=>{setJWriting("");setJWritePanel("");}); }} />
              <div className="journal-write-footer">
                <select className="write-sel" style={{border:"1px solid #2E2E2E"}} value={jWritePanel} onChange={e=>setJWritePanel(e.target.value)}>
                  <option value="">Tag panel...</option>
                  {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                </select>
                <span style={{fontFamily:"DM Mono,monospace",fontSize:9,color:"#6B6B6B",letterSpacing:1}}>⌘+Enter</span>
                <button className="post-btn" style={{marginLeft:"auto"}} onClick={()=>postNote(jWriting,jWritePanel,()=>{setJWriting("");setJWritePanel("");})}>Post →</button>
                <button className="upload-btn" style={{background:"transparent",border:"none",borderLeft:"1px solid #2E2E2E",color:"#A8A8A0",padding:"0 14px",fontFamily:"DM Mono,monospace",fontSize:10,letterSpacing:1,textTransform:"uppercase",cursor:"pointer"}} onClick={()=>setShowModal(true)}>↑ Upload</button>
              </div>
            </div>
            <div className="journal-body">
              <div className="journal-filters">
                <div className="jf-section">
                  <span className="jf-label">Type</span>
                  {[["all","All"],["notes","Notes"],["uploads","Uploads"]].map(([val,lbl])=>(
                    <button key={val} className={`jf-btn ${jFilter===val?"on":""}`} onClick={()=>setJFilter(val)}>{lbl}</button>
                  ))}
                </div>
                <div className="jf-section">
                  <span className="jf-label">Panel</span>
                  <button className={`jf-btn ${!jPanel?"on":""}`} onClick={()=>setJPanel(null)}>All</button>
                  {PANELS.map(p=>(
                    <button key={p.id} className="jf-btn"
                      style={jPanel===p.id?{background:p.color,color:"#FFFFFF"}:{}}
                      onClick={()=>setJPanel(jPanel===p.id?null:p.id)}>
                      {p.icon} {p.label}
                    </button>
                  ))}
                </div>
              </div>
              <div className="journal-feed">
                {groups.length===0 ? (
                  <div className="journal-empty" style={{padding:"60px 40px",textAlign:"center"}}>
                    <div style={{fontFamily:"Playfair Display,serif",fontSize:20,fontWeight:700,color:"#A8A8A0",marginBottom:6}}>Nothing here yet</div>
                    <div style={{fontFamily:"DM Sans,sans-serif",fontSize:13,color:"#A8A8A0"}}>Write a note above or adjust your filters</div>
                  </div>
                ) : groups.map(group=>(
                  <div key={group.date} className="day-group">
                    <div className="day-header">
                      <span className="day-date">{group.date}</span>
                      <span className="day-count">{group.entries.length} {group.entries.length===1?"entry":"entries"}</span>
                    </div>
                    {group.entries.map(entry=>{
                      const panels=(entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
                      const isEditing = editingId === entry.id;
                      return (
                        <div key={entry.id} className="journal-entry">
                          <div className="je-meta">
                            <span className="je-time">{entry.time}</span>
                            {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
                            {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                            <div className="je-actions">
                              <button className="je-edit" onClick={()=>{ setEditingId(entry.id); setEditText(entry.text); }}>Edit</button>
                              <button className="je-del" onClick={()=>delEntry(entry.id)}>✕</button>
                            </div>
                          </div>
                          {entry.sourceTitle&&<span className="je-src">↳ {entry.sourceTitle}</span>}
                          {isEditing ? (
                            <div>
                              <textarea className="j-edit-ta" value={editText} onChange={e=>setEditText(e.target.value)} rows={4} autoFocus />
                              <button className="j-edit-save" onClick={()=>saveEdit(entry.id)}>Save</button>
                              <button className="j-edit-cancel" onClick={()=>setEditingId(null)}>Cancel</button>
                            </div>
                          ) : (
                            <div className="je-text">{entry.text}</div>
                          )}
                          {entry.takeaway&&(
                            <div className="je-takeaway">
                              <span className="je-takeaway-label">Your takeaway</span>
                              <div className="je-takeaway-text">{entry.takeaway}</div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ── HOME PAGE ────────────────────────────────────────────────────────────
      const visibleEntries = filterPanel ? entries.filter(e=>(e.panels||[]).includes(filterPanel)) : entries;

      return (
        <div style={{fontFamily:"DM Sans,sans-serif",background:C.cream,minHeight:"100vh",color:C.black}}>
          <style>{CSS}</style>
          <div className={`toast ${showToast?"show":""}`}>✓ Saved</div>
          {showModal&&renderModal()}

          <Nav current="home" />
          <Masthead right="Personal Intelligence" />

          {/* SEARCH */}
          <div className="search-wrap">
            <span className="search-icon">⌕</span>
            <input className="search-input" placeholder="Search entries…" value={searchQ} onChange={e=>setSearchQ(e.target.value)} />
            {searchQ&&<span className="search-count">{searchResults.length} result{searchResults.length!==1?"s":""}</span>}
            {searchQ&&<button className="search-clear" onClick={()=>setSearchQ("")}>Clear</button>}
          </div>

          {searchQ.trim().length>1 ? (
            <div className="search-results">
              <div className="sr-hdr">Results for "{searchQ}"</div>
              {searchResults.length===0
                ? <div style={{textAlign:"center",padding:"60px 0",fontFamily:"Playfair Display,serif",fontSize:18,color:"#A8A8A0"}}>No results found</div>
                : searchResults.map(entry=>{
                    const panels=(entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
                    return (
                      <div key={entry.id} className="sr-entry" onClick={()=>{if(panels[0]){setActivePanelId(panels[0].id);setView("panel");}}}>
                        <div className="j-meta">
                          <span className="j-date">{entry.date} · {entry.time}</span>
                          {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
                          {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                        </div>
                        {entry.sourceTitle&&<span className="j-src">↳ {entry.sourceTitle}</span>}
                        <div className="j-txt" dangerouslySetInnerHTML={{__html:highlight(entry.text,searchQ)}} />
                        {entry.takeaway&&<div style={{marginTop:6,fontFamily:"Playfair Display,serif",fontSize:13,color:"#1B4D35",fontStyle:"italic"}}>↳ {entry.takeaway}</div>}
                      </div>
                    );
                  })
              }
            </div>
          ) : (
            <>
              {/* HOME HERO — Add left, Reading Now right */}
              <div className="home-hero">
                <div className="add-section">
                  <div className="add-section-label">Capture</div>
                  <div className="add-section-title">What are you<br/><em>adding today?</em></div>
                  <div className="add-btns">
                    <button className="add-btn-primary" onClick={()=>{ setModalDest("panel"); setShowModal(true); }}>
                      ↑ Upload or analyze
                    </button>
                    <button className="add-btn-secondary" onClick={()=>{ setModalDest("queue"); setShowModal(true); }}>
                      + Add to Queue
                    </button>
                  </div>
                </div>
                <div className="reading-section">
                  <div className="rn-label">Reading Now</div>
                  <div className="rn-books">
                    {books.map((book,i)=>(
                      <div key={book.id} className="rn-book" style={{"--bc":PANELS[i%PANELS.length].color}}>
                        <div className="rn-book-info">
                          <div className="rn-book-title">{book.title}</div>
                          {book.author&&<div className="rn-book-author">{book.author}</div>}
                        </div>
                        <button className="rn-book-del" onClick={()=>delBook(book.id)}>✕</button>
                      </div>
                    ))}
                    {books.length<3&&!addingBook&&(
                      <button className="rn-add-btn" onClick={()=>setAddingBook(true)}>+ Add book</button>
                    )}
                    {addingBook&&(
                      <div className="rn-form">
                        <input className="rn-inp" placeholder="Title" value={bookTitle} onChange={e=>setBookTitle(e.target.value)} autoFocus
                          onKeyDown={e=>{ if(e.key==="Enter") addBook(); if(e.key==="Escape") setAddingBook(false); }} />
                        <input className="rn-inp" placeholder="Author (optional)" value={bookAuthor} onChange={e=>setBookAuthor(e.target.value)}
                          onKeyDown={e=>{ if(e.key==="Enter") addBook(); if(e.key==="Escape") setAddingBook(false); }} />
                        <div className="rn-form-btns">
                          <button className="rn-save-btn" onClick={addBook}>Add</button>
                          <button className="rn-cancel-btn" onClick={()=>setAddingBook(false)}>Cancel</button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* WRITE BAR */}
              <div className="write-bar">
                <span className="write-lbl">Write</span>
                <input className="write-input" placeholder="What's on your mind?" value={writeText} onChange={e=>setWriteText(e.target.value)}
                  onKeyDown={e=>e.key==="Enter"&&postNote(writeText,writePanel,()=>{setWriteText("");setWritePanel("");})} />
                <select className="write-sel" value={writePanel} onChange={e=>setWritePanel(e.target.value)}>
                  <option value="">Tag panel...</option>
                  {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                </select>
                <button className="post-btn" onClick={()=>postNote(writeText,writePanel,()=>{setWriteText("");setWritePanel("");})}>Post →</button>
              </div>

              {/* MAIN GRID */}
              <div className="main-grid">
                <div className="panels-section">
                  <div className="sec-hdr">
                    <span className="sec-title">Panels</span>
                    <span className="sec-sub">{PANELS.length} active</span>
                  </div>
                  <div className="panel-grid">
                    {PANELS.map(p=>{
                      const count=entries.filter(e=>(e.panels||[]).includes(p.id)).length;
                      return (
                        <div key={p.id} className="pc" style={{"--pc":p.color}} onClick={()=>{ setActivePanelId(p.id); setView("panel"); }}>
                          <span className="pc-icon">{p.icon}</span>
                          <div className="pc-name">{p.label}</div>
                          <div className="pc-count">{count} {count===1?"entry":"entries"}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* RECENT SIDEBAR */}
                <div className="j-sidebar">
                  <div className="sec-hdr">
                    <span className="sec-title">Recent</span>
                    <span className="sec-sub">{entries.length} total</span>
                  </div>
                  <div className="filter-bar">
                    <button className={`fb ${!filterPanel?"on":""}`} onClick={()=>setFilterPanel(null)}>All</button>
                    {PANELS.map(p=>(
                      <button key={p.id} className="fb"
                        style={filterPanel===p.id?{background:p.color,borderColor:p.color,color:"#FFFFFF"}:{}}
                        onClick={()=>setFilterPanel(filterPanel===p.id?null:p.id)}>
                        {p.icon}
                      </button>
                    ))}
                  </div>
                  <div className="j-feed">
                    {visibleEntries.length===0 ? (
                      <div style={{fontFamily:"Playfair Display,serif",fontSize:15,color:"#A8A8A0",padding:"20px 0"}}>Nothing yet.</div>
                    ) : visibleEntries.map(entry=>{
                      const panels=(entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
                      return (
                        <div key={entry.id} className="j-entry">
                          <div className="j-meta">
                            <span className="j-date">{entry.date} · {entry.time}</span>
                            {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
                            {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                            <div className="j-actions">
                              <button className="j-del-btn" onClick={()=>delEntry(entry.id)}>✕</button>
                            </div>
                          </div>
                          {entry.sourceTitle&&<span className="j-src">↳ {entry.sourceTitle}</span>}
                          <div className="j-txt">{entry.text}</div>
                          {entry.takeaway&&(
                            <div className="j-takeaway">
                              <span className="j-takeaway-lbl">Your takeaway</span>
                              <div className="j-takeaway-txt">{entry.takeaway}</div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>

              {/* SOURCES */}
              <div className="sources">
                <div className="src-label">Sources</div>
                <div className="src-grid">
                  {SOURCES.map(({name,desc,href})=>(
                    <div key={name} className="src-item">
                      <div className="src-name">{name}</div>
                      <div className="src-desc">{desc}</div>
                      <a className="src-link" href={href} target="_blank" rel="noreferrer">Open →</a>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(Pangea, null));
  </script>
</body>
</html>
